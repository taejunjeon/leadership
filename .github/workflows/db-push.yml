name: Database Push

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/**/*.sql'
      - 'supabase/migrations/**'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force push even without changes'
        required: false
        default: 'false'

jobs:
  db-push:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: supabase/setup-cli@v1
      with:
        version: latest
    
    - name: Setup PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
    
    - name: Link Supabase project
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_REF: eokkqmqpxqwmlmshhewn
      run: |
        echo "ðŸ”— Linking to Supabase project..."
        supabase link --project-ref $SUPABASE_PROJECT_REF
    
    - name: Push database changes
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      run: |
        echo "ðŸš€ Pushing database changes..."
        supabase db push --password $SUPABASE_DB_PASSWORD
    
    - name: Apply complete fix for 404 error
      env:
        DATABASE_URL: postgres://postgres:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-ap-northeast-2.pooler.supabase.com:5432/postgres
      run: |
        echo "ðŸ”§ Applying complete 404 fix..."
        psql "$DATABASE_URL" < scripts/404-fix-complete.sql || true
    
    - name: Verify tables
      env:
        DATABASE_URL: postgres://postgres:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-ap-northeast-2.pooler.supabase.com:5432/postgres
      run: |
        echo "âœ… Verifying tables..."
        psql "$DATABASE_URL" -c "SELECT table_name, 
          (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = t.table_name) as columns,
          (SELECT COUNT(*) FROM pg_policies WHERE tablename = t.table_name) as policies
          FROM information_schema.tables t 
          WHERE table_schema = 'public' 
          AND table_name IN ('users', 'survey_results', 'survey_responses')
          ORDER BY table_name;"
          
    - name: Summary
      run: |
        echo "âœ¨ Database push completed!"
        echo "ðŸ“ Check your Supabase dashboard for updated schema"
        echo "ðŸ”— Project: https://supabase.com/dashboard/project/eokkqmqpxqwmlmshhewn"